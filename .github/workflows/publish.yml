name: Build and Publish to GitHub Packages

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-publish:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write

    steps:
      - id: checkout
        name: Checkout
        uses: actions/checkout@v5

      - id: setup-node
        name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24
          registry-url: https://npm.pkg.github.com
          scope: '@${{ github.repository_owner }}'

      - id: install
        name: Install dependencies
        run: npm ci

      - id: build
        name: Build package
        run: npm run build

      - id: package-version
        name: Get package version
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT

      - id: version-check
        name: Check if version exists in registry
        continue-on-error: true
        run: |
          # Try to get package info for this version from GitHub Packages
          # If the version exists, npm view will succeed; if not, it will fail
          if npm view ${{ steps.package-version.outputs.name }}@${{ steps.package-version.outputs.version }} version 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.package-version.outputs.version }} already exists in registry"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${{ steps.package-version.outputs.version }} does not exist in registry"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - id: publish
        name: Publish to GitHub Packages
        if: steps.version-check.outputs.exists != 'true' && github.event_name != 'pull_request'
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - id: skip-publish
        name: Skip publish - version already exists
        if: steps.version-check.outputs.exists == 'true'
        run: |
          echo "Skipping publish: version ${{ steps.package-version.outputs.version }} already exists in GitHub Packages"
          echo "Build completed successfully but package was not published"
